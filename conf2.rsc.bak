# mar/13/2019 20:35:43 by RouterOS 6.42.12
# software id = 9HZZ-CCA7
#
# model = 750GL
# serial number = 2C5E020C5729
/interface bridge
add admin-mac=D4:CA:6D:2B:39:B6 auto-mac=no comment=defconf name=bridge
add name=bridge_loopback
/interface list
add comment=defconf name=WAN
add comment=defconf name=LAN
/interface wireless security-profiles
set [ find default=yes ] supplicant-identity=MikroTik
/ip pool
add name=default-dhcp ranges=192.168.88.10-192.168.88.254
/ip dhcp-server
add address-pool=default-dhcp disabled=no interface=bridge name=defconf
/interface bridge port
add bridge=bridge comment=defconf interface=ether3
add bridge=bridge comment=defconf interface=ether4
add bridge=bridge comment=defconf interface=ether5
/ip neighbor discovery-settings
set discover-interface-list=LAN
/interface list member
add comment=defconf interface=bridge list=LAN
add comment=defconf interface=ether1 list=WAN
/ip address
add address=192.168.88.1/24 comment=defconf interface=bridge network=\
    192.168.88.0
/ip dhcp-client
add comment=defconf dhcp-options=hostname,clientid disabled=no interface=\
    ether1
add dhcp-options=hostname,clientid disabled=no interface=ether2
/ip dhcp-server network
add address=192.168.88.0/24 comment=defconf gateway=192.168.88.1
/ip dns
set allow-remote-requests=yes
/ip dns static
add address=192.168.88.1 name=router.lan
/ip firewall filter
add action=accept chain=input comment=\
    "defconf: accept established,related,untracked" connection-state=\
    established,related,untracked disabled=yes
add action=drop chain=input comment="defconf: drop invalid" connection-state=\
    invalid disabled=yes
add action=accept chain=input comment="defconf: accept ICMP" disabled=yes \
    protocol=icmp
add action=drop chain=input comment="defconf: drop all not coming from LAN" \
    disabled=yes in-interface-list=!LAN
add action=accept chain=forward comment="defconf: accept in ipsec policy" \
    disabled=yes ipsec-policy=in,ipsec
add action=accept chain=forward comment="defconf: accept out ipsec policy" \
    disabled=yes ipsec-policy=out,ipsec
add action=accept chain=forward comment=\
    "defconf: accept established,related, untracked" connection-state=\
    established,related,untracked disabled=yes
add action=drop chain=forward comment="defconf: drop invalid" \
    connection-state=invalid disabled=yes
add action=drop chain=forward comment=\
    "defconf:  drop all from WAN not DSTNATed" connection-nat-state=!dstnat \
    connection-state=new disabled=yes in-interface-list=WAN
/ip firewall mangle
add action=mark-routing chain=prerouting in-interface=bridge \
    new-routing-mark=gw1 passthrough=no per-connection-classifier=\
    both-addresses-and-ports:2/1
add action=mark-routing chain=prerouting dst-port=80,443 in-interface=bridge \
    new-routing-mark=gw1 passthrough=no per-connection-classifier=\
    src-address:2/0 protocol=tcp
add action=mark-routing chain=prerouting dst-port=80,443 in-interface=bridge \
    new-routing-mark=gw2 passthrough=no per-connection-classifier=\
    src-address:2/1 protocol=tcp
add action=mark-routing chain=prerouting in-interface=bridge \
    new-routing-mark=gw1 passthrough=no per-connection-classifier=\
    both-addresses-and-ports:2/0
add action=mark-routing chain=output dst-address=8.8.8.8 new-routing-mark=\
    pinggw1 protocol=icmp
add action=mark-routing chain=output dst-address=8.8.4.4 new-routing-mark=\
    pinggw2 protocol=icmp
add action=mark-routing chain=output new-routing-mark=gw1 passthrough=no
/ip firewall nat
add action=masquerade chain=srcnat comment="defconf: masquerade" \
    ipsec-policy=out,none out-interface=ether1
add action=masquerade chain=srcnat comment="defconf: masquerade" \
    ipsec-policy=out,none out-interface=ether2
/ip route
add distance=2 dst-address=192.168.88.0/24 gateway=bridge routing-mark=gw2
add distance=1 dst-address=192.168.88.0/24 gateway=bridge routing-mark=gw1
add distance=1 gateway=bridge_loopback
/ip route rule
add comment=gw1 routing-mark=gw1 table=gw1
add routing-mark=gw1 table=gw2
add comment=gw2 routing-mark=gw2 table=gw2
add routing-mark=gw2 table=gw1
add action=lookup-only-in-table routing-mark=pinggw1 table=gw1
add action=lookup-only-in-table routing-mark=pinggw2 table=gw2
/ip route vrf
add interfaces=ether1 routing-mark=gw1
add interfaces=ether2 routing-mark=gw2
/system clock
set time-zone-name=Asia/Krasnoyarsk
/tool mac-server
set allowed-interface-list=LAN
/tool mac-server mac-winbox
set allowed-interface-list=LAN
/tool netwatch
add down-script=\
    ":log error \"gw1 down\";\r\
    \n/ip route rule disable [find comment=gw1]" host=8.8.8.8 interval=20s \
    up-script=\
    ":log info \"gw1 up\"\r\
    \n/ip route rule enable [find comment=gw1]"
