# jul/11/2018 12:58:52 by RouterOS 6.41.4
# software id = E21M-0E11
#
# model = 951Ui-2HnD
# serial number = 64310506B859

/interface bridge
add admin-mac=E4:8D:8C:41:AC:DE auto-mac=no fast-forward=no name=bridge-local

/interface ethernet
set [ find default-name=ether1 ] name=ether1-gateway
set [ find default-name=ether2 ] name=ether2-master-local
set [ find default-name=ether3 ] name=ether3-slave-local
set [ find default-name=ether4 ] name=ether4-slave-local
set [ find default-name=ether5 ] name=ether5-slave-local

/interface pppoe-client
add add-default-route=yes default-route-distance=0 disabled=no interface=\
    ether1-gateway keepalive-timeout=60 name=pppoe-cli password=782135436534 \
    user=wimax773@telebit.ru

/interface wireless
set [ find default-name=wlan1 ] name=wlan3 ssid=FNM-Piter

/interface gre
add name=gre-tun-fnm-kvarts remote-address=91.227.188.27
add name=gre-tun-fnm-silinet remote-address=46.44.17.42

/interface list
add exclude=dynamic name=discover
add name=mactel
add name=mac-winbox

/interface wireless security-profiles
set [ find default=yes ] supplicant-identity=MikroTik
add authentication-types=wpa2-psk eap-methods="" mode=dynamic-keys name=psk \
    supplicant-identity=MikroTik wpa2-pre-shared-key=1234567890pp

/ip ipsec proposal
set [ find default=yes ] enc-algorithms=aes-128-cbc

/ip pool
add name=dhcp_pool1 ranges=192.168.155.100-192.168.155.200

/ip dhcp-server
add address-pool=dhcp_pool1 authoritative=after-2sec-delay disabled=no \
    interface=bridge-local lease-script=":if (\$leaseBound = 1) do={\r\
    \n\t/ip dhcp-server lease;\r\
    \n\t:foreach i in=[find dynamic=yes] do={\r\
    \n\t\t:local dhcpip \r\
    \n\t\t:set dhcpip [ get \$i address ];\r\
    \n\t\t:local clientid\r\
    \n\t\t:set clientid [get \$i host-name];\r\
    \n\t\t:if (\$leaseActIP = \$dhcpip) do={\r\
    \n\t\t\t:local comment \"New IP\"\r\
    \n\t\t\t:set comment ( \$comment . \": \" .  \$dhcpip . \": \" . \$clienti\
    d);\r\
    \n\t\t\t/log error \$comment;\r\
    \n\t\t\t/tool e-mail send from=\"alert1@wesmir.com\" password=\"CHTbz3UMlj\
    uNCR\" to=\"it@wesmir.com\" user=\"alert1@wesmir.com\" server=\"smtp.yande\
    x.ru\" port=465 start-tls=tls-only subject=(\"New client connected on Kaza\
    n office at \" . [/system clock get time] . \" \" . [/system clock get dat\
    e]) body=(\"New client IP:\$leaseActIP; MAC:\$leaseActMAC; DHCP-Server:\$l\
    easeServerName; Hostname:\$clientid\");\r\
    \n\t\t}\r\
    \n\t}\r\
    \n}" lease-time=2d name=Kazan-local

/routing ospf instance
set [ find default=yes ] redistribute-connected=as-type-1 router-id=\
    192.168.155.1

/snmp community
set [ find default=yes ] addresses=0.0.0.0/0

/tool user-manager customer
set admin access=\
    own-routers,own-users,own-profiles,own-limits,config-payment-gw

/interface bridge port
add bridge=bridge-local interface=ether2-master-local
add bridge=bridge-local hw=no interface=*E
add bridge=bridge-local interface=ether4-slave-local
add bridge=bridge-local interface=ether5-slave-local
add bridge=bridge-local interface=ether3-slave-local

/ip neighbor discovery-settings
set discover-interface-list=discover

/interface list member
add interface=ether2-master-local list=discover
add interface=ether3-slave-local list=discover
add interface=ether4-slave-local list=discover
add interface=ether5-slave-local list=discover
add interface=bridge-local list=discover
add interface=gre-tun-fnm-silinet list=discover
add interface=gre-tun-fnm-kvarts list=discover
add list=discover
add list=discover
add list=discover
add interface=wlan3 list=discover
add interface=pppoe-cli list=discover
add interface=ether2-master-local list=mactel
add interface=ether3-slave-local list=mactel
add interface=ether2-master-local list=mac-winbox
add interface=ether4-slave-local list=mactel
add interface=ether5-slave-local list=mactel
add list=mactel
add interface=ether3-slave-local list=mac-winbox
add interface=ether4-slave-local list=mac-winbox
add interface=bridge-local list=mactel
add interface=ether5-slave-local list=mac-winbox
add list=mac-winbox
add interface=bridge-local list=mac-winbox

/ip address
add address=192.168.155.1/24 comment="default configuration" interface=\
    bridge-local network=192.168.155.0
add address=192.168.4.221/30 interface=gre-tun-fnm-silinet network=\
    192.168.4.220
add address=192.168.4.225/30 interface=gre-tun-fnm-kvarts network=\
    192.168.4.224

/ip cloud
set ddns-enabled=yes

/ip dhcp-client
add comment="default configuration" default-route-distance=3 dhcp-options=\
    hostname,clientid disabled=no interface=ether1-gateway

/ip dhcp-server lease
add address=192.168.155.187 comment=mfu mac-address=84:BA:3B:99:D8:96 server=\
    Kazan-local

	
/ip dhcp-server network
add address=192.168.155.0/24 dns-server=77.88.8.88,77.88.8.2 gateway=\
    192.168.155.1

	/ip dns
set allow-remote-requests=yes servers=77.88.8.88,77.88.8.2

/ip dns static
add address=192.168.88.1 name=router
add address=192.168.125.150 name=server2008

/ip firewall filter
add action=log chain=forward log=yes log-prefix=gre protocol=gre
add action=accept chain=input comment="default configuration" protocol=icmp
add action=accept chain=input comment="default configuration" protocol=gre
add action=accept chain=input comment="default configuration" \
    connection-state=established,related
add action=drop chain=input comment="drop ssh brute forcers" dst-port=22 \
    protocol=tcp src-address-list=ssh_blacklist
add action=add-src-to-address-list address-list=ssh_blacklist \
    address-list-timeout=1w3d chain=input connection-state=new dst-port=22 \
    protocol=tcp src-address-list=ssh_stage3
add action=add-src-to-address-list address-list=ssh_stage3 \
    address-list-timeout=1m chain=input connection-state=new dst-port=22 \
    protocol=tcp src-address-list=ssh_stage2
add action=add-src-to-address-list address-list=ssh_stage2 \
    address-list-timeout=1m chain=input connection-state=new dst-port=22 \
    protocol=tcp src-address-list=ssh_stage1
add action=add-src-to-address-list address-list=ssh_stage1 \
    address-list-timeout=1m chain=input connection-state=new dst-port=22 \
    protocol=tcp
add chain=input comment=SSH connection-state=new dst-port=22,4400 protocol=\
    tcp
add action=drop chain=input comment="default configuration" in-interface=\
    ether1-gateway
add action=fasttrack-connection chain=forward comment="default configuration" \
    connection-state=established,related
add action=accept chain=forward comment="default configuration" \
    connection-state=established,related
add action=drop chain=forward comment="default configuration" \
    connection-state=invalid
add action=drop chain=forward comment="default configuration" \
    connection-nat-state=!dstnat connection-state=new in-interface=\
    ether1-gateway
add action=drop chain=input comment="default configuration" in-interface=\
    pppoe-cli
add action=drop chain=forward comment="default configuration" \
    connection-nat-state=!dstnat connection-state=new in-interface=pppoe-cli

	/ip firewall nat
add action=masquerade chain=srcnat comment="default configuration" \
    out-interface=pppoe-cli to-addresses=194.226.161.186
add action=masquerade chain=srcnat comment="default configuration" \
    out-interface=ether1-gateway to-addresses=194.226.161.186

	/ip firewall service-port
set tftp disabled=yes
set irc disabled=yes
set h323 disabled=yes
set sip disabled=yes
set pptp disabled=yes
set udplite disabled=yes
set dccp disabled=yes
set sctp disabled=yes

/ip service
set telnet disabled=yes
set ftp disabled=yes
set www address=192.168.125.0/24,192.168.155.0/24
set api disabled=yes
set winbox port=4400
set api-ssl disabled=yes

/routing filter
add action=accept chain=ospf-in prefix=10.10.10.0/24 prefix-length=0-128
add action=accept chain=ospf-in prefix=192.168.125.0/24 prefix-length=0-128
add action=accept chain=ospf-in prefix=192.168.135.0/24 prefix-length=0-128
add action=accept chain=ospf-in prefix=192.168.153.0/24 prefix-length=0-128
add action=accept chain=ospf-in prefix=192.168.157.0/24 prefix-length=0-128
add action=accept chain=ospf-in prefix=192.168.161.0/24 prefix-length=0-128
add action=accept chain=ospf-in prefix=192.168.163.0/24 prefix-length=0-128
add action=accept chain=ospf-in prefix=192.168.4.0/24 prefix-length=0-128
add action=discard chain=ospf-in
add action=accept chain=ospf-out prefix=192.168.155.0/24 prefix-length=0-128
add action=accept chain=ospf-out prefix=192.168.4.0/24 prefix-length=0-128
add action=discard chain=ospf-out

/routing ospf interface
add authentication=simple authentication-key=1234567890pp interface=\
    gre-tun-fnm-silinet network-type=broadcast
add authentication=simple authentication-key=1234567890pp cost=7 interface=\
    gre-tun-fnm-kvarts network-type=broadcast

	/routing ospf network
add area=backbone network=192.168.4.0/24


/system clock
set time-zone-autodetect=no time-zone-name=Europe/Moscow

/system identity
set name="FNM-Kazan'"

/system logging
add disabled=yes topics=dhcp

/system ntp client
set enabled=yes primary-ntp=89.109.251.21 secondary-ntp=89.109.251.25

/tool mac-server
set allowed-interface-list=mactel

/tool mac-server mac-winbox
set allowed-interface-list=mac-winbox

/tool user-manager database
set db-path=user-manager
